name: skip checks

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:

jobs:
  skip-checks:
    timeout-minutes: 200
    strategy:
      fail-fast: false
      matrix:
        include:
          #- os: 'macos-14'
            #android-sdk: '6.1'
            #xcode: '16.4'
          - os: 'macos-15-intel'
            android-sdk: '6.2'
          - os: 'macos-26'
            android-sdk: 'nightly-6.3'
    runs-on: ${{ matrix.os }}
    #env:
    #  DEVELOPER_DIR: /Applications/Xcode_${{ matrix.xcode }}.app/Contents/Developer
    steps:
      # larger projects sometimes yield: Unhandled exception. System.IO.IOException: No space left on device : '/Users/runner/runners/â€¦
      - name: Free Disk Space
        run: sudo rm -rf /Applications/Xcode_14*.app /Applications/Xcode_15*.app /Applications/Xcode_16.app /Applications/Xcode_16.1.app /Applications/Xcode_16_2.app /Applications/Xcode_16.3.app
      - uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: current
          add-job-summary: never
      - name: Cache Homebrew packages
        uses: actions/cache@v5
        with:
          path: ~/Library/Caches/Homebrew
          key: homebrew-packages

      - name: Install Skip
        uses: skiptools/actions/setup-skip@v1
        with:
          verbose: true

      - run: skip android emulator create --name demo --verbose

      # installs in the wrong place
      - run: mv -v ${HOMEBREW_PREFIX}/share/android-commandlinetools/system-images ${ANDROID_SDK_ROOT}/

      # TODO:
      #- run: skip android emulator create --name demo --verbose -- --sdk_root=${ANDROID_SDK_HOME}/

      #- run: brew install tree
      #- run: tree /Users/runner/Library/Android/sdk/system-images/
      #- run: tree ${ANDROID_HOME}

      # need to override ANDROID_SDK_HOME so it searches in:
      # /opt/homebrew/share/android-commandlinetools/system-images/android-34/google_apis/arm64-v8a
      # instead of:
      # /Users/runner/Library/Android/sdk/system-images/android-34/google_apis/arm64-v8a/
      #- run: ANDROID_SDK_ROOT=${HOMEBREW_PREFIX}/share/android-commandlinetools/ skip android emulator launch --background --name demo --verbose
      - run: skip android emulator launch --background --name demo --verbose

      - name: Skip Checkup
        run: skip checkup
      #- run: skip checkup --verbose --double-check

      - run: skip init --transpiled-model demo-module DemoModule
      - run: skip init --transpiled-app --appid=xyz.skip.Demo demo-app DemoApp DemoModule
      - run: skip init --transpiled-app --appfair demo-appfair DemoFairApp

      # setup Android SDK and emulator
      - run: skip android sdk install --version ${{ matrix.android-sdk }} --verbose

      # native model and app init
      - run: skip checkup --verbose --native

      - run: skip checkup --verbose --native-model
      - run: skip init --native-model demo-module-native DemoModule
      - run: skip init --native-model --kotlincompat demo-module-kotlincompat DemoModule
      - run: skip init --native-model --appid=xyz.skip.Demo demo-native-model-app DemoApp DemoModule

      - run: skip checkup --verbose --native-app
      - run: skip init --native-app --appid=xyz.skip.Demo demo-app-native DemoApp
      - run: skip init --native-app --native-model --appid=xyz.skip.Demo demo-app-native-model DemoApp DemoModel
      - run: skip export --project demo-app-native-model --arch x86_64 --arch aarch64 --arch armv7

